name: Deploy

on:
    push:
        branches:
            - main

jobs:
    build:
      runs-on: ubuntu-latest
      
      strategy:
        max-parallel: 4
        matrix:
          python-version: [3.12.4]

      steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v3
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          cp .env.backup .env

      - name: Run Tests
        run: |
          python manage.py test

    deploy:
        runs-on: ubuntu-latest

        steps:

        - name: Install sshpass
          run: |
            sudo apt update
            sudo apt install -y sshpass
    
        - name: Adding ssh-key to known_hosts
          run: |
            mkdir -p ~/.ssh
            ssh-keyscan -H ${{ secrets.HOST }} >> ~/.ssh/known_hosts
        
        - name: Deploy to server & restart
          run: |
            sshpass -p "${{ secrets.PASSWORD }}" ssh -T ${{ secrets.USERNAME }}@${{ secrets.HOST }} << EOF
            cd ${{ secrets.PATH }}
            ${{ secrets.DEPLOY_COMMAND }}
            ${{ secrets.INSTALL_REQ_COMMAND }}
            ${{ secrets.MIGRATE_COMMAND }}
            ${{ secrets.COLLECT_STATIC_COMMAND }}
            ${{ secrets.RESTART_COMMAND }}
